## タスク生成の戦略

### 依存関係の分析
要件間の暗黙の依存関係を特定し、実装順序を決定する:
- **型・インターフェース定義** → それを使う実装
- **データ生成・構築** → そのデータを利用する処理（出力、表示、変換など）
- **基盤機能** → 統合・拡張機能
- **内部ロジック** → 外部インターフェース（CLI, API, UI）
- **コア実装** → テスト

**重要**: データや状態を「作る側」のタスクが完了してから「使う側」のタスクを実行できるよう、depends_on を設定すること。

### 段階的生成
全要件を一度にカバーする必要はない。確実に実装できる基盤部分から生成する:
- 初回: 型定義、データモデル、コア機能など土台となる要件
- 後続イテレーション: 残りの要件を順次カバー

依存関係が不明確な要件や、既存コードの調査が必要な要件は、後続イテレーションに回してよい。

### タスク粒度
タスクの分割・統合は実装の難易度と検証の複雑さで判断する:

**統合すべきケース（1タスクにまとめる）:**
- 難易度が低く、編集箇所が類似している変更
- 同一ファイルや密接に関連するファイルへの単純な追加
- 1回の動作検証で完了を確認できる作業

**分割すべきケース（複数タスクに分ける）:**
- 難易度が高く、実装に試行錯誤が必要な機能
- 複数の独立した箇所を編集する必要がある作業
- 複数回の動作検証が必要な実装（段階的に確認したい場合）

**単独タスクにすべきでないもの:**
- 定数定義、型定義、スキーマ定義など、動作検証の余地がほとんどないもの
  → それを使う実装タスクに含めるか、関連する複数の定義をまとめる
- コード品質条件（lint pass、型チェック pass など）
  → 大規模リファクタリングを除き、単体タスクではなく他タスクの validation 条件とする
- ユニットテストのみの作成
  → 実装タスクにユニットテストを含める形にする。統合テストは独立タスクとして可

タスク数を増やしすぎない。類似の小さな変更を個別タスクにせず、関連するものはまとめる。

## タスク設計の原則

1. **単一責任**: 1タスク = 1つの明確な成果物
2. **検証可能**: 各タスクに機械的に確認可能な validation を定義
3. **依存関係の明示**: depends_on で順序を制御
4. **自己完結**: 各タスクの instruction は単独で実行可能な情報を含む
5. **セットアップと作業の分離**: ツールのインストール等のセットアップは、それを使う作業と同一タスクにしない
6. **カバレッジ追跡**: 各 validation で対応する acceptance_criteria / design_decisions の ID を covers で明示（後続イテレーションで残りをカバー可能）

## verify パターンとタスク内容

requirements の verify フィールドにはパターンが指定されている。タスクはこのパターンに応じた検証を可能にする実装を含めること:

| verify パターン | タスクに含めるべき実装 |
|----------------|----------------------|
| `[metrics_check]` | pytest でレポート/オブジェクトのプロパティ・値を検証するテスト |
| `[cli_test]` | pytest でコマンド実行・引数差分を検証するテスト |
| `[flow_order]` | pytest で spy/mock を使い呼び出し順序を検証するテスト |
| `[intermediate]` | pytest で中間生成物のフォーマット・プロパティを検証するテスト |
| `[regression]` | （実装完了後に追加）pytest で数値の許容誤差内一致を検証するテスト |

**重要**: 機能実装だけでなく、verify を満たすテスト実装もタスクに含める。テストが pass することが validation の判定基準となる。

## 出力フォーマット

```yaml
tasks:
  - id: task_1
    name: {タスク名}
    depends_on: []
    instruction: |
      {具体的な作業指示}

      ## 変更対象
      - `{path/to/file}`: {変更内容}

      ## 関連パス
      - `{path/to/related}`: {役割・関係性}
    validation:
      - criterion: "{検証項目1}"
        covers: [req_id.1, req_id.2]  # acceptance_criteria
      - criterion: "{検証項目2}"
        covers: [req_id.3, req_id.d1]  # design_decisions は req_id.d{N} 形式
```
