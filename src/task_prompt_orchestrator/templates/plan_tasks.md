---
description: tasks.yaml（Loop C用タスク定義）を作成・修正する
---

# タスク定義ファイル作成・修正（/plan_tasks）

tasks.yaml を作成または修正します。

## tasks.yaml とは

Loop C で順次実行するための **タスク定義** ファイル。
各タスクに具体的な作業指示と検証項目を記載し、自動実行・検証を行う。

## requirements.yaml との関係

tasks.yaml は requirements.yaml の `acceptance_criteria` と `design_decisions` を詳細な実装タスクにブレイクダウンしたもの。

- **acceptance_criteria**: ユーザー視点の要件 → タスクの目的
- **design_decisions**: 技術判断 → タスクの実装方針

## 可視化資料（実装指示の補助）

instruction にテキストで書くより、図表やサンプルを見せた方が実装意図が明確に伝わるケースがある。
**詳細設計ではなく、タスク実装時の判断材料**として使う点に注意。

### 可視化が有効なケース

| ケース | 可視化方法 | 伝わること |
|--------|------------|------------|
| 出力フォーマット | サンプル出力（実データ or モック） | 期待する出力形式 |
| コンポーネント構成 | コンポーネント図（Mermaid等） | 実装すべきモジュールと責務 |
| データフロー/パイプライン | フロー図・パイプライン図 | 処理ステップと入出力の流れ |
| 処理フロー | シーケンス図 | 実装すべき処理順序・呼び出し関係 |

### 参照方法

`doc/design/{feature-name}-visual.md` を作成し、instruction から参照する:

```yaml
- id: task_report
  name: 売上レポート出力の実装
  instruction: |
    doc/design/sales-report-visual.md のサンプル出力形式に従って実装する。

    ## 変更対象
    - `src/reports/sales.py`: レポート生成ロジック
```

## モード判定

- **引数なし**: 新規作成モード
- **引数あり**: 既存ファイルの修正モード

---

## 新規作成モード

### 手順

1. **目的・スコープの把握**
   - 指示内容から機能名を抽出
   - 実現したいことの範囲を確認

2. **コードベース調査**（必要に応じて）
   - 関連する既存コード
   - 変更対象ファイルの特定

3. **タスクの分解・設計**
   - 単一責任の原則に従って分解
   - 依存関係の整理
   - 各タスクに検証項目を定義

4. **出力**
   - `doc/design/{feature-name}-tasks.yaml` に保存

### 出力フォーマット

```yaml
# 出力先: doc/design/{feature-name}-tasks.yaml

# 前提条件（タスク開始前に完了しておくべき簡単な準備作業）
# - {ツールのインストール等}: `{コマンド}`
# ※ 数分で完了する作業のみ記載。それ以上かかる場合は独立したタスクにする

tasks:
  - id: task_1
    name: {タスク名}
    depends_on: []
    instruction: |
      {具体的な作業指示}

      ## 変更対象
      - `src/{path/to/file}`: {変更内容}

      ## 関連パス
      - `src/{path/to/related}`: {役割・関係性}
    validation:
      - "{検証項目}"

  - id: task_2
    name: {タスク名}
    depends_on: [task_1]
    instruction: |
      {具体的な作業指示}
    validation:
      - "{検証項目}"
```

---

## 修正モード

### 手順

1. **既存ファイルの読み込み**

2. **問題点の分析**
   - タスクの粒度は適切か
   - 依存関係に矛盾はないか
   - 検証項目は明確か
   - 指示内容は自己完結しているか

3. **改善提案の提示**
   - 問題点と改善案を明示
   - ユーザーに確認

4. **更新**
   - 承認後、ファイルを更新

---

## タスク設計の原則

1. **単一責任**: 1タスク = 1つの明確な成果物

2. **検証可能**: 各タスクに機械的に確認可能な validation を定義

3. **依存関係の明示**: depends_on で順序を制御

4. **自己完結**: 各タスクの instruction は単独で実行可能な情報を含む

5. **セットアップと作業の分離**: ツールのインストール等のセットアップは、それを使う作業と同一タスクにしない
   - 前提条件として記載: 失敗リスクが低く数分で完了するもの
   - 独立タスクにする: 失敗リスクがある、または後続タスクの依存元になるもの
   - 悪い例: 「xenonインストール + complexityチェック」を1タスクに
   - 良い例: task_setup_xenon → task_complexity_check（depends_on: [task_setup_xenon]）

---

## スコープ

このコマンドの責務は **tasks.yaml ファイルの作成・更新のみ**。

後続の実行（`task-orchestrator run`）はユーザーが判断する。
